<!DOCTYPE html>
<html>
<head>
  <title>ë„ì„œ ëŒ€ì—¬ DApp</title>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .book { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
    button { margin-left: 10px; }
    table { margin-top: 20px; border-collapse: collapse; width: 100%; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
  </style>
</head>
<body>
  <h2>ğŸ“š ë„ì„œ ëŒ€ì—¬ ì‹œìŠ¤í…œ</h2>

  <div id="adminControls" style="display:none; margin-bottom:20px;">
    <h3>ğŸ“˜ ë„ì„œ ë“±ë¡ (ê´€ë¦¬ì ì „ìš©)</h3>
    <input type="text" id="bookTitle" placeholder="ë„ì„œ ì œëª© ì…ë ¥" />
    <button onclick="addBook()">ë„ì„œ ì¶”ê°€</button>
  </div>

  <div id="bookList">ë¡œë”© ì¤‘...</div>

  <h3>ğŸ“œ ëŒ€ì—¬ ê¸°ë¡</h3>
  <table id="history" border="1" cellpadding="5">
    <thead>
      <tr><th>ëŒ€ì—¬ì</th><th>ì±… ë²ˆí˜¸</th><th>ì œëª©</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const contractAddress = "0x65b1A7A9662CE572A785B9ecf240f917717f5eD4";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_title",
				"type": "string"
			}
		],
		"name": "addBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "bookId",
				"type": "uint256"
			}
		],
		"name": "BookRemoved",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "bookId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "title",
				"type": "string"
			}
		],
		"name": "BookRented",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "uint256",
				"name": "bookId",
				"type": "uint256"
			}
		],
		"name": "BookReturned",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_bookId",
				"type": "uint256"
			}
		],
		"name": "removeBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_bookId",
				"type": "uint256"
			}
		],
		"name": "rentBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_bookId",
				"type": "uint256"
			}
		],
		"name": "returnBook",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "admin",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "bookCount",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "books",
		"outputs": [
			{
				"internalType": "string",
				"name": "title",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "isAvailable",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "borrower",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_bookId",
				"type": "uint256"
			}
		],
		"name": "getBook",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let provider, signer, contract, userAddress;
    let isAdmin = false;

    async function init() {
      if (!window.ethereum) return alert("Metamask ì„¤ì¹˜ í•„ìš”");
      await ethereum.request({ method: "eth_requestAccounts" });
      await setup();

      window.ethereum.on("accountsChanged", async () => {
        await setup();
      });
    }

    async function setup() {
      provider = new ethers.providers.Web3Provider(window.ethereum);
      signer = provider.getSigner();
      userAddress = await signer.getAddress();
      contract = new ethers.Contract(contractAddress, contractABI, signer);

      const adminAddr = await contract.admin();
      isAdmin = adminAddr.toLowerCase() === userAddress.toLowerCase();
      document.getElementById("adminControls").style.display = isAdmin ? "block" : "none";

      loadBooks();
      loadRentalHistory();
    }

    async function loadBooks() {
      const count = await contract.bookCount();
      const listDiv = document.getElementById("bookList");
      listDiv.innerHTML = "";

      for (let i = 0; i < count; i++) {
        const [title, isAvailable, borrower] = await contract.getBook(i);
        const div = document.createElement("div");
        div.className = "book";

        if (title === "deleted") {
          div.innerHTML = `
            <b style="color:gray;">ì‚­ì œëœ ë„ì„œ</b><br>
            <span style="color:red;">ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ë„ì„œì…ë‹ˆë‹¤.</span>
          `;
          listDiv.appendChild(div);
          continue;
        }

        div.innerHTML = `
          <b>${title}</b><br>
          ìƒí™©: ${isAvailable ? "ëŒ€ì—¬ ê°€ëŠ¥" : `ëŒ€ì—¬ ì¤‘ by ${shortAddr(borrower)}`}
          <button onclick="${isAvailable ? `rentBook(${i})` : `returnBook(${i})`}"
            ${!isAvailable && borrower.toLowerCase() !== userAddress.toLowerCase() ? "disabled" : ""}>
            ${isAvailable ? "ëŒ€ì—¬" : "ë°˜ë‚©"}
          </button>
          ${isAdmin ? `<button onclick="removeBook(${i})" style="color:red;">ì‚­ì œ</button>` : ""}
        `;
        listDiv.appendChild(div);
      }
    }

    async function addBook() {
      const title = document.getElementById("bookTitle").value.trim();
      if (!title) return alert("ë„ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      try {
        const tx = await contract.addBook(title);
        await tx.wait();
        alert("ğŸ“š ë„ì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        document.getElementById("bookTitle").value = "";
        loadBooks();
      } catch (err) {
        alert("âŒ ë“±ë¡ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function rentBook(id) {
      try {
        const tx = await contract.rentBook(id);
        await tx.wait();
        alert("ğŸ“¦ ëŒ€ì—¬ ì™„ë£Œ");
        loadBooks();
        loadRentalHistory();
      } catch (err) {
        alert("âŒ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function returnBook(id) {
      try {
        const tx = await contract.returnBook(id);
        await tx.wait();
        alert("ğŸ“¤ ë°˜ë‚© ì™„ë£Œ");
        loadBooks();
      } catch (err) {
        alert("âŒ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function removeBook(id) {
      try {
        const tx = await contract.removeBook(id);
        await tx.wait();
        alert("ğŸ—‘ ë„ì„œ ì‚­ì œ ì™„ë£Œ");
        loadBooks();
      } catch (err) {
        alert("âŒ ì‚­ì œ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function loadRentalHistory() {
      try {
        const events = await contract.queryFilter("BookRented", 0, "latest");
        const tbody = document.querySelector("#history tbody");
        tbody.innerHTML = "";

        for (const e of events) {
          const { user, bookId, title } = e.args;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${shortAddr(user)}</td>
            <td>${bookId.toString()}</td>
            <td>${title}</td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("âŒ ëŒ€ì—¬ ê¸°ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
      }
    }

    function shortAddr(addr) {
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    init();
  </script>
</body>
</html>
